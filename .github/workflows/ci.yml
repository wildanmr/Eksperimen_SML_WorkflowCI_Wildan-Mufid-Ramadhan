name: MLflow CI/CD Pipeline

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      use_dagshub:
        description: 'Use DagsHub for MLflow tracking'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      n_estimators:
        description: 'Number of estimators (optional)'
        required: false
        default: ''
      max_depth:
        description: 'Max depth (optional)'
        required: false
        default: ''

env:
  DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
  DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
  MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
  MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
  MLFLOW_TRACKING_URI: https://dagshub.com/wildanmr/SMSML_Wildan-Mufid-Ramadhan.mlflow
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_HUB_TOKEN : ${{ secrets.DOCKER_HUB_TOKEN  }}
  DATASET_URL: https://github.com/wildanmr/Eksperimen_SML_Wildan-Mufid-Ramadhan/releases/latest/download/diabetes_preprocessed.csv

jobs:
  train-model:
    runs-on: ubuntu-latest
    
    outputs:
      run-id: ${{ steps.mlflow-run.outputs.run-id }}
      experiment-id: ${{ steps.mlflow-run.outputs.experiment-id }}
    
    # Use bash shell with conda initialization
    defaults:
      run:
        shell: bash -l {0}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v2
      with:
        miniconda-version: 'latest'
        activate-environment: diabetes-ml-env
        environment-file: MLProject/conda.yaml
        auto-activate-base: false
        auto-update-conda: true
        python-version: '3.11'
    
    - name: Install MLflow
      run: |
        conda info
        conda list
        # MLflow should be installed from conda.yaml, but ensure it's available
        pip install mlflow[extras]
        mlflow --version
        
    - name: Download dataset to MLProject directory
      run: |
        cd MLProject
        curl -L -o diabetes_preprocessed.csv ${{ env.DATASET_URL }}
        ls -la *.csv
    
    - name: Run MLflow Project with conda environment
      id: mlflow-run
      env:
        # Ensure authentication environment variables are set
        DAGSHUB_USERNAME: ${{ env.DAGSHUB_USERNAME }}
        DAGSHUB_TOKEN: ${{ env.DAGSHUB_TOKEN }}
        MLFLOW_TRACKING_USERNAME: ${{ env.DAGSHUB_USERNAME }}
        MLFLOW_TRACKING_PASSWORD: ${{ env.DAGSHUB_TOKEN }}
        MLFLOW_TRACKING_URI: ${{ env.MLFLOW_TRACKING_URI }}
        # Prevent OAuth flow in CI
        DAGSHUB_CLIENT_FAIL_IF_NO_TOKEN: "true"
      run: |
        cd MLProject
        
        # Verify authentication environment variables
        echo "ğŸ” Checking authentication setup..."
        if [ -z "$DAGSHUB_USERNAME" ]; then
          echo "âŒ DAGSHUB_USERNAME not set"
          exit 1
        fi
        if [ -z "$DAGSHUB_TOKEN" ]; then
          echo "âŒ DAGSHUB_TOKEN not set"
          exit 1
        fi
        echo "âœ… Authentication credentials are configured"
        echo "ğŸ‘¤ Username: $DAGSHUB_USERNAME"
        echo "ğŸ”— Tracking URI: $MLFLOW_TRACKING_URI"
        
        # Set parameters from workflow inputs
        USE_DAGSHUB="${{ github.event.inputs.use_dagshub || 'true' }}"
        N_ESTIMATORS="${{ github.event.inputs.n_estimators }}"
        MAX_DEPTH="${{ github.event.inputs.max_depth }}"
        
        echo "ğŸš€ Running MLflow Project with mlflow run..."
        echo "ğŸ”§ Use DagsHub: $USE_DAGSHUB"
        echo "ğŸŒ³ N Estimators: ${N_ESTIMATORS:-'default (grid search)'}"
        echo "ğŸ“ Max Depth: ${MAX_DEPTH:-'default (grid search)'}"
        
        # Build mlflow run command with parameters
        MLFLOW_CMD="mlflow run . --experiment-name CI_Auto_Training -P use_dagshub=$USE_DAGSHUB --env-manager conda"
        
        # Add optional parameters if provided
        if [ ! -z "$N_ESTIMATORS" ]; then
          MLFLOW_CMD="$MLFLOW_CMD -P n_estimators=$N_ESTIMATORS"
        fi
        
        if [ ! -z "$MAX_DEPTH" ]; then
          MLFLOW_CMD="$MLFLOW_CMD -P max_depth=$MAX_DEPTH"
        fi
        
        echo "ğŸ“ Command: $MLFLOW_CMD"
        echo ""
        
        # Run with authentication already set in environment
        echo "ğŸ”„ Starting MLflow run with authentication..."
        set -o pipefail
        
        # Run command with all environment variables properly set
        PYTHONUNBUFFERED=1 eval "$MLFLOW_CMD" | tee /tmp/mlflow_output.log
        
        echo "ğŸ“‹ MLflow Run Output:"
        cat /tmp/mlflow_output.log
        
        echo ""
        echo "ğŸ” Extracting run information..."
        
        # Extract run ID from DagsHub URL in the output
        RUN_ID=$(grep -oP "runs/\K[a-f0-9]{32}" /tmp/mlflow_output.log | tail -n 1)
        EXPERIMENT_ID=$(grep -oP "experiments/\K[0-9]+" /tmp/mlflow_output.log | tail -n 1)
        
        # Fallback values if extraction fails
        if [ -z "$RUN_ID" ]; then
          RUN_ID="check-dagshub-ui"
        fi
        if [ -z "$EXPERIMENT_ID" ]; then
          EXPERIMENT_ID="2"
        fi
        
        echo "run-id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "experiment-id=$EXPERIMENT_ID" >> $GITHUB_OUTPUT
        
        echo "âœ… MLflow run completed"
        echo "ğŸ†” Run ID: $RUN_ID" 
        echo "ğŸ”¬ Experiment ID: $EXPERIMENT_ID"
        
        # Verify artifacts were created
        if [ -d "artifacts" ]; then
          echo "ğŸ“ Artifacts created:"
          ls -la artifacts/
        fi
        
        if [ -d "saved_models" ]; then
          echo "ğŸ’¾ Models saved:"
          ls -la saved_models/
        fi
    
    - name: Upload artifacts to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: ml-artifacts-${{ github.ref_name }}
        path: |
          MLProject/artifacts/
          MLProject/saved_models/
          MLProject/mlruns/
        retention-days: 30

    - name: Create release archive
      run: |
        echo "ğŸ“¦ Creating release archive..."
        cd MLProject
        tar -czf ../ml-artifacts-${{ github.ref_name }}.tar.gz \
          artifacts/ \
          saved_models/ \
          mlruns/
        cd ..
        echo "âœ… Archive created: ml-artifacts-${{ github.ref_name }}.tar.gz"

    - name: Upload artifacts to release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        tag_name: ${{ github.ref_name }}
        name: ML Artifacts Release ${{ github.ref_name }}
        body: |
          ğŸ¤– **Automated ML Artifacts Release**
          
          This release contains the machine learning artifacts for tag ${{ github.ref_name }}:
          - ğŸ“Š Training artifacts and metrics
          - ğŸ¯ Saved models
          - ğŸ“ˆ MLflow runs data
          
          **Run Details:**
          - Run ID: ${{ steps.mlflow-run.outputs.run-id }}
          - Experiment ID: ${{ steps.mlflow-run.outputs.experiment-id }}
          - Commit: ${{ github.sha }}
        files: |
          ml-artifacts-${{ github.ref_name }}.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-docker:
    needs: train-model
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
    
    - name: Download dataset for Docker build
      run: |
        cd MLProject
        curl -L -o diabetes_preprocessed.csv ${{ env.DATASET_URL }}
    
    - name: Setup Miniconda for MLflow build
      uses: conda-incubator/setup-miniconda@v2
      with:
        miniconda-version: 'latest'
        activate-environment: diabetes-ml-env
        environment-file: MLProject/conda.yaml
        auto-activate-base: false
        auto-update-conda: true
        python-version: '3.11'
    
    - name: Install MLflow for Docker build
      shell: bash -l {0}
      run: |
        conda list
        # MLflow should be available from environment, add extras if needed
        pip install mlflow[extras]
    
    - name: Build MLflow Docker image using mlflow build-docker
      shell: bash -l {0}
      env:
        RUN_ID: ${{ needs.train-model.outputs.run-id }}
        EXPERIMENT_ID: ${{ needs.train-model.outputs.experiment-id }}
        MLFLOW_TRACKING_URI: ${{ env.MLFLOW_TRACKING_URI }}
        MLFLOW_TRACKING_USERNAME: ${{ env.DAGSHUB_USERNAME }}
        MLFLOW_TRACKING_PASSWORD: ${{ env.DAGSHUB_TOKEN }}
      run: |
        echo "ğŸ³ Building MLflow Docker image..."
        echo "ğŸ†” Using Run ID: $RUN_ID"
        echo "ğŸ”¬ Using Experiment ID: $EXPERIMENT_ID"
        echo "ğŸ·ï¸ Using Tag: ${{ github.ref_name }}"
        
        cd MLProject
        
        # Login to registries
        echo "ğŸ” Logging into registries..."
        echo "${{ env.DOCKER_HUB_TOKEN }}" | docker login -u "${{ env.DOCKER_HUB_USERNAME }}" --password-stdin
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
        
        # Build Docker image with MLflow (latest tag)
        echo "ğŸ”¨ Building image with latest tag..."
        mlflow models build-docker \
          -m "runs:/$RUN_ID/best_model" \
          -n "${{ env.DOCKER_HUB_USERNAME }}/diabetes-ml-mlflow:latest" \
          --enable-mlserver
        
        # Tag for different registries and versions
        echo "ğŸ·ï¸ Creating additional tags..."
        
        # Docker Hub tags
        docker tag "${{ env.DOCKER_HUB_USERNAME }}/diabetes-ml-mlflow:latest" \
          "${{ env.DOCKER_HUB_USERNAME }}/diabetes-ml-mlflow:${{ github.ref_name }}"
        
        # GHCR tags
        docker tag "${{ env.DOCKER_HUB_USERNAME }}/diabetes-ml-mlflow:latest" \
          "ghcr.io/${{ github.repository_owner }}/diabetes-ml-mlflow:latest"
        docker tag "${{ env.DOCKER_HUB_USERNAME }}/diabetes-ml-mlflow:latest" \
          "ghcr.io/${{ github.repository_owner }}/diabetes-ml-mlflow:${{ github.ref_name }}"
        
        # Push all images
        echo "ğŸš€ Pushing images..."
        
        # Push to Docker Hub
        docker push "${{ env.DOCKER_HUB_USERNAME }}/diabetes-ml-mlflow:latest"
        docker push "${{ env.DOCKER_HUB_USERNAME }}/diabetes-ml-mlflow:${{ github.ref_name }}"
        
        # Push to GHCR
        docker push "ghcr.io/${{ github.repository_owner }}/diabetes-ml-mlflow:latest"
        docker push "ghcr.io/${{ github.repository_owner }}/diabetes-ml-mlflow:${{ github.ref_name }}"
        
        echo "âœ… All images built and pushed successfully!"

  deploy-info:
    needs: [train-model, build-docker]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Display deployment info
      env:
        RUN_ID: ${{ needs.train-model.outputs.run-id }}
        EXPERIMENT_ID: ${{ needs.train-model.outputs.experiment-id }}
      run: |
        echo "ğŸ¯ ML Pipeline Completed!"
        echo "=========================================="
        echo ""
        echo "ğŸ“Š MLflow Tracking: https://dagshub.com/wildanmr/SMSML_Wildan-Mufid-Ramadhan.mlflow"
        if [ "$EXPERIMENT_ID" != "" ] && [ "$EXPERIMENT_ID" != "no-experiment-found" ]; then
          echo "ğŸ”¬ Experiment: https://dagshub.com/wildanmr/SMSML_Wildan-Mufid-Ramadhan.mlflow/#/experiments/$EXPERIMENT_ID"
        fi
        if [ "$RUN_ID" != "" ] && [ "$RUN_ID" != "no-run-found" ] && [[ ! "$RUN_ID" =~ ^error- ]]; then
          echo "ğŸ†” Run: https://dagshub.com/wildanmr/SMSML_Wildan-Mufid-Ramadhan.mlflow/#/experiments/$EXPERIMENT_ID/runs/$RUN_ID"
        fi
        echo ""
        echo "ğŸ³ Docker Images:"
        echo "  - Docker Hub: ${{ env.DOCKER_HUB_USERNAME }}/diabetes-ml-mlflow:latest"
        echo "  - Docker Hub: ${{ env.DOCKER_HUB_USERNAME }}/diabetes-ml-mlflow:${{ github.ref_name }}"
        echo "  - GHCR: ghcr.io/${{ github.repository_owner }}/diabetes-ml-mlflow:latest"
        echo "  - GHCR: ghcr.io/${{ github.repository_owner }}/diabetes-ml-mlflow:${{ github.ref_name }}"
        echo ""
        echo "ğŸ“ Artifacts saved to GitHub Actions artifacts"
        echo "ğŸ”„ Training method: mlflow run with conda environment"
        echo "ğŸ”„ Re-training triggered by: ${{ github.event_name }}"